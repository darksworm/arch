#!/bin/bash
set -e

# Partitions
PARTITIONS_INSTALL_DEV=/dev/nvme0n1
PARTITIONS_HOME_PARTITION_SIZE_MiB=426431
PARTITIONS_ROOT_PARTITION_SIZE_MiB=61440
PARTITIONS_EFI_PARTITION_SIZE_MiB=512

echo -n "Checking network connectivity -> "
ping -c 1 -W 3 google.com &> /dev/null || ( echo "ERROR" && exit 1 ) && echo "OK"

timedatectl set-ntp true

EFI_PARTITION_END=$PARTITIONS_EFI_PARTITION_SIZE_MiB
ROOT_PARTITION_END=$(expr $EFI_PARTITION_END + $PARTITIONS_ROOT_PARTITION_SIZE_MiB)
HOME_PARTITION_END=$(expr $ROOT_PARTITION_END + $PARTITIONS_HOME_PARTITION_SIZE_MiB)

# create disk partitions
parted --script $PARTITIONS_INSTALL_DEV \
    mklabel gpt \
    mkpart primary fat32    1MiB                       ${EFI_PARTITION_END}MiB  \
    mkpart primary ext4     ${EFI_PARTITION_END}MiB    ${ROOT_PARTITION_END}MiB \
    mkpart primary ext4     ${ROOT_PARTITION_END}MiB   ${HOME_PARTITION_END}MiB \
    set 1 esp on

PARTITIONS_EFI_DEV=${PARTITIONS_INSTALL_DEV}p1
PARTITIONS_ROOT_DEV=${PARTITIONS_INSTALL_DEV}p2
PARTITIONS_HOME_DEV=${PARTITIONS_INSTALL_DEV}p3

echo "Setting up LUKS for home partition"
cryptsetup luksFormat ${PARTITIONS_HOME_DEV}
cryptsetup open ${PARTITIONS_HOME_DEV} home

mkfs.ext4 /dev/mapper/home
mkfs.ext4 ${PARTITIONS_ROOT_DEV}
mkfs.vfat ${PARTITIONS_EFI_DEV}

echo "Partition setup complete."

mount ${PARTITIONS_ROOT_DEV} /mnt
mkdir /mnt/boot /mnt/home
mount ${PARTITIONS_EFI_DEV}  /mnt/boot
mount /dev/mapper/home /mnt/home

pacstrap /mnt base base-devel linux linux-firmware grub efibootmgr vim lvm2 sudo dhcpcd git
HOME_UUID=$(cryptsetup luksUUID ${PARTITIONS_HOME_DEV})
echo home   UUID=${HOME_UUID}   none    luks,discard >> /mnt/etc/crypttab

genfstab -U /mnt >> /mnt/etc/fstab
echo /dev/mapper/home   /home   ext4    defaults    0 1 >> /mnt/etc/fstab

cp chroot.sh /mnt
cp .config /mnt
arch-chroot /mnt ./chroot.sh

rm /mnt/chroot.sh
rm /mnt/.config

umount /mnt/home
umount /mnt/boot
umount /mnt

cryptsetup close home
